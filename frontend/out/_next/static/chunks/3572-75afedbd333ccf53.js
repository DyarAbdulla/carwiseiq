"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3572],{63572:function(e,t,r){r.d(t,{apiClient:function(){return k},LP:function(){return g},gy:function(){return w},o4:function(){return y}});var a=r(54829);class o{getCacheKey(e,t){let r=t?Object.keys(t).sort().map(e=>"".concat(e,"=").concat(JSON.stringify(t[e]))).join("&"):"";return"".concat(e).concat(r?"?".concat(r):"")}get(e,t){let r=this.getCacheKey(e,t),a=this.cache.get(r);return a?Date.now()-a.timestamp>this.DEFAULT_TTL?(this.cache.delete(r),null):a.data:null}set(e,t,r){let a=this.getCacheKey(e,r);this.cache.set(a,{data:t,timestamp:Date.now()})}async getOrFetch(e,t,r,a){let o=this.getCacheKey(e,r),i=this.get(e,r);if(null!==i)return i;let n=this.pendingRequests.get(o);if(n)return n;let s=t().then(t=>(this.set(e,t,r),this.pendingRequests.delete(o),t)).catch(e=>{throw this.pendingRequests.delete(o),e});return this.pendingRequests.set(o,s),s}clear(e,t){if(e){let r=this.getCacheKey(e,t);this.cache.delete(r),this.pendingRequests.delete(r)}else this.cache.clear(),this.pendingRequests.clear()}clearExpired(){let e=Date.now();Array.from(this.cache.entries()).forEach(t=>{let[r,a]=t;e-a.timestamp>this.DEFAULT_TTL&&this.cache.delete(r)})}constructor(){this.cache=new Map,this.pendingRequests=new Map,this.DEFAULT_TTL=3e5}}let i=new o;setInterval(()=>{i.clearExpired()},6e4);let n="http://localhost:8000",s="http://localhost:8000".replace(":3001",":8000"),c=a.Z.create({baseURL:n,headers:{"Content-Type":"application/json"},timeout:3e4,withCredentials:!0}),l=a.Z.create({baseURL:s,headers:{"Content-Type":"application/json"},timeout:3e4,withCredentials:!0}),d=a.Z.create({baseURL:n,headers:{"Content-Type":"application/json"},timeout:12e4,withCredentials:!0}),u=new Map,h=e=>"".concat(e.method,":").concat(e.url,":").concat(JSON.stringify(e.params||{})),p=e=>{var t,r,a;return(null===(t=e.method)||void 0===t?void 0:t.toLowerCase())==="get"&&!(null===(r=e.headers)||void 0===r?void 0:r["Cache-Control"])&&!(null===(a=e.headers)||void 0===a?void 0:a["cache-control"])};c.interceptors.request.use(e=>{if(e.data&&"undefined"!=typeof FormData&&e.data instanceof FormData){let t=e.headers;t&&"Content-Type"in t&&delete t["Content-Type"]}return e}),c.interceptors.request.use(e=>{if(p(e)){let t=h(e),r=u.get(t);r&&Date.now()-r.timestamp<3e5&&(e.__fromCache=!0,e.__cachedData=r.data)}return e}),c.interceptors.response.use(e=>{if(e.config.__fromCache)return{...e,data:e.config.__cachedData};let t=h(e.config);return p(e.config)&&u.set(t,{data:e.data,timestamp:Date.now()}),e},async e=>{var t;if(e.config.__fromCache){let t=h(e.config);return u.delete(t),delete e.config.__fromCache,delete e.config.__cachedData,c.request(e.config)}let r=e.config;if(!r)return Promise.reject(e);void 0===r.__retryCount&&(r.__retryCount=0);let a=null===(t=e.response)||void 0===t?void 0:t.status;if(a>=500&&a<600&&r.__retryCount<2){r.__retryCount+=1;let e=1e3*Math.pow(2,r.__retryCount-1);return await new Promise(t=>setTimeout(t,e)),c.request(r)}return Promise.reject(e)});let g=()=>localStorage.getItem("auth_token"),m=async()=>{try{let{supabase:e}=await Promise.all([r.e(3226),r.e(4641)]).then(r.bind(r,45922)),{data:{session:t},error:a}=await e.auth.getSession();if(a)return console.error("[getSupabaseToken] Session error:",a),null;if(!t)return null;let o=t.expires_at;if(o&&o-Math.floor(Date.now()/1e3)<300)try{let{data:{session:r},error:a}=await e.auth.refreshSession();if(a)return console.error("[getSupabaseToken] Refresh error:",a),t.access_token||null;if(null==r?void 0:r.access_token)return r.access_token}catch(e){console.error("[getSupabaseToken] Exception during refresh:",e)}return t.access_token||null}catch(e){return console.error("[getSupabaseToken] Error getting Supabase session:",e),null}},y=e=>{localStorage.setItem("auth_token",e),c.defaults.headers.common.Authorization="Bearer ".concat(e),l.defaults.headers.common.Authorization="Bearer ".concat(e),d.defaults.headers.common.Authorization="Bearer ".concat(e),localStorage.getItem("auth_token")||console.error("[setToken] CRITICAL: Token was not saved!")},w=()=>{localStorage.removeItem("auth_token"),localStorage.removeItem("refresh_token"),sessionStorage.removeItem("auth_token"),sessionStorage.removeItem("refresh_token"),delete c.defaults.headers.common.Authorization,delete l.defaults.headers.common.Authorization,delete d.defaults.headers.common.Authorization};c.interceptors.request.use(async e=>{var t,r,a,o;if((null===(t=e.url)||void 0===t?void 0:t.includes("/api/favorites"))||(null===(r=e.url)||void 0===r?void 0:r.includes("/api/marketplace"))||(null===(a=e.url)||void 0===a?void 0:a.includes("/api/auth/me"))||(null===(o=e.url)||void 0===o?void 0:o.includes("/api/messaging"))){let t=await m();if(t&&"string"==typeof t&&t.length>0)return e.headers.Authorization="Bearer ".concat(t),e;let r=g();r&&"string"==typeof r&&r.length>0?e.headers.Authorization="Bearer ".concat(r):(console.warn("[API Interceptor] ⚠️ No token available for protected endpoint:",e.url),console.warn("[API Interceptor] Supabase token:",!!t,"REST token:",!!r))}else{let t=g();t&&(e.headers.Authorization="Bearer ".concat(t))}return e},e=>(console.error("[API Interceptor] Request setup error:",e),Promise.reject(e))),l.interceptors.request.use(e=>{if(e.url&&(String(e.url).includes("/api/auth/login")||String(e.url).includes("/api/auth/register")))return e;let t=localStorage.getItem("admin_token"),r=g(),a=t||r;return a&&(e.headers.Authorization="Bearer ".concat(a)),e}),d.interceptors.request.use(async e=>{var t,r;if((null===(t=e.url)||void 0===t?void 0:t.includes("/api/favorites"))||(null===(r=e.url)||void 0===r?void 0:r.includes("/api/marketplace"))){let t=await m();if(t&&"string"==typeof t&&t.length>0)return e.headers.Authorization="Bearer ".concat(t),e}let a=g();return a&&(e.headers.Authorization="Bearer ".concat(a)),e}),d.interceptors.response.use(e=>e,e=>{var t;if((null===(t=e.response)||void 0===t?void 0:t.status)===401){w(),delete d.defaults.headers.common.Authorization;{localStorage.removeItem("auth_token"),localStorage.removeItem("refresh_token"),sessionStorage.removeItem("auth_token"),sessionStorage.removeItem("refresh_token");let e=window.location.pathname,t=e.includes("/login")||e.includes("/register"),r=e.includes("/favorites")||e.includes("/my-listings")||e.includes("/profile");if(!t&&!r){let t=e.match(/^\/([a-z]{2})(?:\/|$)/),r=t?t[1]:"en";window.location.href="/".concat(r,"/login")}}}return Promise.reject(e)});let v=!1,f=[],_=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;f.forEach(r=>{e?r.reject(e):r.resolve(t)}),f=[]};l.interceptors.response.use(e=>e,async e=>{var t,r,a,o,i;let n=e.config,s=String((null==n?void 0:n.url)||""),c=s.includes("/api/auth/login")||s.includes("/api/auth/register"),d=s.includes("/api/auth/refresh");if((null===(t=e.response)||void 0===t?void 0:t.status)===401&&(c||d))return Promise.reject(e);if((null===(r=e.response)||void 0===r?void 0:r.status)===401&&!n._retry){if(v)return new Promise((e,t)=>{f.push({resolve:e,reject:t})}).then(e=>(n.headers.Authorization="Bearer ".concat(e),l(n))).catch(e=>Promise.reject(e));n._retry=!0,v=!0;let e=localStorage.getItem("refresh_token");if(e)try{let t=(await l.post("/api/auth/refresh",{refresh_token:e})).data.access_token;if(t)return y(t),l.defaults.headers.common.Authorization="Bearer ".concat(t),n.headers.Authorization="Bearer ".concat(t),_(null,t),v=!1,l(n)}catch(e){_(e,null),v=!1,w(),localStorage.removeItem("refresh_token"),delete l.defaults.headers.common.Authorization;{let e=window.location.pathname;e.includes("/login")||e.includes("/register")||(window.location.href="/en/login")}}else{_(Error("No refresh token"),null),v=!1,w(),localStorage.removeItem("refresh_token"),delete l.defaults.headers.common.Authorization;{let e=window.location.pathname;e.includes("/login")||e.includes("/register")||(window.location.href="/en/login")}}}return(null===(a=e.response)||void 0===a?void 0:a.status)===429&&(null===(i=e.response)||void 0===i||null===(o=i.data)||void 0===o||o.detail),Promise.reject(e)}),c.interceptors.response.use(e=>e,async e=>{var t,a,o,i;let n=e.config;if((null===(t=e.response)||void 0===t?void 0:t.status)===401){if(n&&!n._retry){n._retry=!0;try{let{supabase:e}=await Promise.all([r.e(3226),r.e(4641)]).then(r.bind(r,45922)),{data:{session:t},error:a}=await e.auth.refreshSession();if(!a&&(null==t?void 0:t.access_token))return n.headers.Authorization="Bearer ".concat(t.access_token),c(n)}catch(e){console.error("[API Interceptor] Token refresh failed:",e)}}console.error("[API Interceptor] ❌ 401 Unauthorized - authentication failed"),w(),delete c.defaults.headers.common.Authorization;{localStorage.removeItem("auth_token"),localStorage.removeItem("refresh_token"),sessionStorage.removeItem("auth_token"),sessionStorage.removeItem("refresh_token");let e=window.location.pathname,t=e.includes("/login")||e.includes("/register"),r=e.includes("/favorites")||e.includes("/my-listings")||e.includes("/profile");if(!t&&!r){let t=e.match(/^\/([a-z]{2})(?:\/|$)/),r=t?t[1]:"en";window.location.href="/".concat(r,"/login")}}}else(null===(a=e.response)||void 0===a?void 0:a.status)===404?console.error("Resource not found:",null===(i=e.config)||void 0===i?void 0:i.url):(null===(o=e.response)||void 0===o?void 0:o.status)===500?window.location.pathname.includes("/errors"):!e.response&&e.request&&(console.error("Network error - check connection"),window.location.pathname.includes("/errors"));return Promise.reject(e)});let E=e=>{if(a.Z.isAxiosError(e)){var t,r,o,i,n,s,c;if((null===(t=e.response)||void 0===t?void 0:t.status)===422||(null===(r=e.response)||void 0===r?void 0:r.status)===400){let t=null===(c=e.response.data)||void 0===c?void 0:c.detail;if(Array.isArray(t))return t.map(e=>{var t;let r=(null===(t=e.loc)||void 0===t?void 0:t.join("."))||"field",a=e.msg||"Invalid value";return"".concat(r,": ").concat(a)}).join(", ");if("string"==typeof t)return t}let a=null===(i=e.response)||void 0===i?void 0:null===(o=i.data)||void 0===o?void 0:o.detail;return"string"==typeof a?a:(null===(s=e.response)||void 0===s?void 0:null===(n=s.data)||void 0===n?void 0:n.message)||e.message||"An error occurred"}return e instanceof Error?e.message:"An unknown error occurred"},k={async getHealth(){try{return(await c.get("/api/health")).data}catch(e){throw Error(E(e))}},async predictPrice(e,t){try{if(!e||"object"!=typeof e)throw console.error("❌ [API] Invalid car features provided:",e),Error("Invalid car features provided");let r=["make","model","year","mileage","engine_size","cylinders","condition","fuel_type","location"].filter(t=>!e[t]);if(r.length>0)throw console.error("❌ [API] Missing required fields:",{missingFields:r,features:e}),Error("Missing required fields: ".concat(r.join(", ")));if(!e.make||!e.model||!e.year)throw console.error("❌ [API] Missing basic required fields:",{make:e.make,model:e.model,year:e.year}),Error("Missing required fields: make, model, and year are required");let a={features:e};t&&t.length>0&&(a.image_features=t);let o=await c.post("/api/predict",a);if(!o||!o.data||"object"!=typeof o.data)throw console.error("❌ [API] Invalid response from server:",o),Error("Invalid response from server");if("number"!=typeof o.data.predicted_price)throw console.error("❌ [API] Response missing predicted_price:",o.data),Error("Response missing predicted_price");return o.data}catch(e){var r,a,o;throw console.error("❌ [API] predictPrice error:",{error:e,errorMessage:null==e?void 0:e.message,errorResponse:null==e?void 0:null===(r=e.response)||void 0===r?void 0:r.data,errorStatus:null==e?void 0:null===(a=e.response)||void 0===a?void 0:a.status,errorStatusText:null==e?void 0:null===(o=e.response)||void 0===o?void 0:o.statusText}),Error(E(e))}},async predictBatch(e){try{try{return(await c.post("/api/predict/batch",{cars:e})).data.predictions}catch(r){console.warn("⚠️ [API] Batch endpoint failed, falling back to individual calls:",r);let t=[];for(let r=0;r<e.length;r++){let a=e[r];try{let e=await this.predictPrice(a);t.push({car:a,predicted_price:e.predicted_price,confidence_interval:e.confidence_interval})}catch(o){console.error("❌ [API] Prediction ".concat(r+1,"/").concat(e.length," failed:"),o),t.push({car:a,predicted_price:0,confidence_interval:void 0,error:o.message||"Prediction failed"})}}return t}}catch(e){throw console.error("❌ [API] Batch prediction failed completely:",e),Error(E(e))}},getMakes:async()=>i.getOrFetch("/api/cars/makes",async()=>{try{return(await c.get("/api/cars/makes")).data}catch(t){let{CAR_MAKES:e}=await r.e(6771).then(r.bind(r,6771));return e}},void 0,18e5),getModels:async e=>i.getOrFetch("/api/cars/models/".concat(encodeURIComponent(e)),async()=>{try{return(await c.get("/api/cars/models/".concat(encodeURIComponent(e)))).data}catch(a){let{MODELS_BY_MAKE:t}=await r.e(6771).then(r.bind(r,6771));return t[e]||[]}},{make:e},18e5),async getLocations(){let e=["Baghdad","Erbil","Basra","Mosul","Kirkuk","Najaf","Karbala","Sulaymaniyah","Duhok","Al-Fallujah","Ramadi","Samarra","Baqubah","Amara","Diwaniyah","Kut","Hillah","Nasiriyah","Dubai","Abu Dhabi","California","Texas","New York","London","Berlin","Istanbul"];return i.getOrFetch("/api/cars/locations",async()=>{try{let t=await c.get("/api/cars/locations"),r=Array.isArray(null==t?void 0:t.data)?t.data:[];return r.length>0?r:e}catch(t){return e}},void 0,18e5)},getTrims:async(e,t)=>i.getOrFetch("/api/cars/trims/".concat(encodeURIComponent(e),"/").concat(encodeURIComponent(t)),async()=>{try{return(await c.get("/api/cars/trims/".concat(encodeURIComponent(e),"/").concat(encodeURIComponent(t)))).data}catch(e){throw Error(E(e))}},{make:e,model:t},18e5),async getAllEngineSizes(){try{return(await c.get("/api/cars/engine-sizes",{headers:{"Cache-Control":"max-age=300"}})).data.map(e=>({size:e,display:e===Math.floor(e)?"".concat(Math.floor(e),"L"):"".concat(e,"L")}))}catch(e){return console.error("Error fetching all engine sizes:",e),[1,1.2,1.4,1.5,1.6,1.8,2,2.5,3,3.5,4,5,6].map(e=>({size:e,display:e===Math.floor(e)?"".concat(Math.floor(e),"L"):"".concat(e,"L")}))}},async getAvailableYears(e,t){try{var r;let e=await this.getMetadata(),t=null!==(r=null==e?void 0:e.year_range)&&void 0!==r?r:{min:2010,max:2025},a=[];for(let e=t.min;e<=t.max;e++)a.push(e);return{years:a}}catch(e){return{years:[2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024,2025]}}},async getAvailableEngines(e,t){try{return(await c.get("/api/available-engines?make=".concat(encodeURIComponent(e),"&model=").concat(encodeURIComponent(t)),{headers:{"Cache-Control":"max-age=300"}})).data.engines||[]}catch(e){return console.error("Error fetching engines:",e),[]}},async getAvailableCylinders(e,t,r){try{return(await c.get("/api/available-cylinders?make=".concat(encodeURIComponent(e),"&model=").concat(encodeURIComponent(t),"&engine=").concat(r),{headers:{"Cache-Control":"max-age=300"}})).data.cylinders||[4]}catch(e){return console.error("Error fetching cylinders:",e),[4]}},async getAvailableColors(e,t){try{return(await c.get("/api/available-colors?make=".concat(encodeURIComponent(e),"&model=").concat(encodeURIComponent(t)),{headers:{"Cache-Control":"max-age=300"}})).data.colors||[]}catch(e){return console.error("Error fetching colors:",e),["White","Black","Silver","Gray","Red","Blue","Green","Gold","Brown","Orange","Yellow","Purple","Beige","Other"]}},async getAvailableFuelTypes(e,t){try{return(await c.get("/api/cars/fuel-types/".concat(encodeURIComponent(e),"/").concat(encodeURIComponent(t)),{headers:{"Cache-Control":"max-age=300"}})).data||[]}catch(e){return console.error("Error fetching fuel types:",e),["Gasoline","Diesel","Electric","Hybrid","Plug-in Hybrid","Other"]}},getMetadata:async()=>i.getOrFetch("/api/cars/metadata",async()=>{try{return(await c.get("/api/cars/metadata")).data}catch(e){throw Error(E(e))}},void 0,18e5),async getStats(){try{let e=(await c.get("/api/stats/basic")).data;return{total_cars:e.total_cars,average_price:e.average_price,median_price:e.median_price,min_price:e.min_price,max_price:e.max_price,year_range:e.year_range,top_makes:e.top_makes}}catch(e){return console.error("Failed to fetch stats:",e),{total_cars:62181,average_price:18776,median_price:16200,min_price:1e3,max_price:2e5,year_range:{min:1948,max:2025}}}},async getStatsSummary(){try{return(await c.get("/api/stats/summary")).data}catch(e){throw Error(E(e))}},async searchBudget(e){try{return(await c.get("/api/budget/search",{params:e})).data}catch(e){throw Error(E(e))}},async exportExcel(e){try{let t=await Promise.all([r.e(1425),r.e(6919)]).then(r.bind(r,7504)),a=t.utils.json_to_sheet(e),o=t.utils.book_new();t.utils.book_append_sheet(o,a,"Predictions");let i=t.write(o,{bookType:"xlsx",type:"array"});return new Blob([i],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}catch(e){throw Error(E(e))}},async exportPDF(e){try{throw Error("PDF export not yet implemented")}catch(e){throw Error(E(e))}},downloadBlob(e,t){let r=window.URL.createObjectURL(e),a=document.createElement("a");a.href=r,a.download=t,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(r),document.body.removeChild(a)},async register(e,t,r,a){let o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];try{if(!e||"string"!=typeof e||!t||"string"!=typeof t)throw Error("Email and password are required");if(t!==r)throw Error("Passwords do not match");if(!o)throw Error("You must accept the Terms of Service");let i=await l.post("/api/auth/register",{email:e,password:t,confirm_password:r,full_name:a,terms_accepted:o});if(!i||!i.data)throw Error("Invalid response from server");let n=i.data.access_token;if(n&&"string"==typeof n&&(y(n),l.defaults.headers.common.Authorization="Bearer ".concat(n)),i.data.refresh_token&&localStorage.setItem("refresh_token",i.data.refresh_token),!i.data.user||"object"!=typeof i.data.user)throw Error("Invalid user data received");return{token:n||"",refresh_token:i.data.refresh_token,user:i.data.user}}catch(e){throw console.error("Register error:",e),Error(E(e))}},async login(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{if(!e||"string"!=typeof e||!t||"string"!=typeof t)throw Error("Email and password are required");let a=await l.post("/api/auth/login",{email:e,password:t,remember_me:r});if(!a||!a.data)throw console.error("[apiClient.login] ❌ Invalid response from server"),Error("Invalid response from server");let o=a.data.access_token;if(!o||"string"!=typeof o)throw console.error("[apiClient.login] ❌ No valid token in response!"),console.error("[apiClient.login] Full response:",JSON.stringify(a.data,null,2)),Error("No access token received from server");if(y(o),l.defaults.headers.common.Authorization="Bearer ".concat(o),!localStorage.getItem("auth_token")){console.error("[apiClient.login] ❌ CRITICAL: Token was not saved! Attempting manual save...");try{localStorage.setItem("auth_token",o),await new Promise(e=>setTimeout(e,50)),localStorage.getItem("auth_token")||console.error("[apiClient.login] ❌❌❌ MANUAL SAVE FAILED! localStorage might be blocked!")}catch(e){console.error("[apiClient.login] ❌ localStorage.setItem threw error:",e)}}return a.data.refresh_token&&localStorage.setItem("refresh_token",a.data.refresh_token),{token:o,refresh_token:a.data.refresh_token,user:a.data.user}}catch(e){var a,o;throw console.error("[apiClient.login] ========== LOGIN ERROR =========="),console.error("[apiClient.login] Error:",e),console.error("[apiClient.login] Error message:",e.message),console.error("[apiClient.login] Error response:",e.response),console.error("[apiClient.login] Error status:",null===(a=e.response)||void 0===a?void 0:a.status),console.error("[apiClient.login] Error data:",null===(o=e.response)||void 0===o?void 0:o.data),Error(E(e))}},async refreshToken(e){try{let t=await l.post("/api/auth/refresh",{refresh_token:e}),r=t.data.access_token;return r&&(y(r),l.defaults.headers.common.Authorization="Bearer ".concat(r)),t.data}catch(e){throw Error(E(e))}},async verifyEmail(e){try{await l.post("/api/auth/verify-email",{token:e})}catch(e){throw Error(E(e))}},async resendVerification(e){try{await l.post("/api/auth/resend-verification",{email:e})}catch(e){throw Error(E(e))}},async forgotPassword(e){try{await l.post("/api/auth/forgot-password",{email:e})}catch(e){throw Error(E(e))}},async resetPassword(e,t,r){try{await l.post("/api/auth/reset-password",{token:e,new_password:t,confirm_password:r})}catch(e){throw Error(E(e))}},async updateProfile(e){try{return(await l.put("/api/auth/profile",e)).data}catch(e){throw Error(E(e))}},async changePassword(e,t,r){try{await l.put("/api/auth/change-password",{current_password:e,new_password:t,confirm_password:r})}catch(e){throw Error(E(e))}},async updatePrivacySettings(e){try{await l.put("/api/auth/privacy-settings",e)}catch(e){throw e}},async exportData(){try{return(await l.get("/api/auth/export-data")).data}catch(e){throw Error(E(e))}},async deleteAccount(){try{await l.delete("/api/auth/account"),w(),localStorage.removeItem("refresh_token")}catch(e){throw Error(E(e))}},async logoutAll(){try{await l.post("/api/auth/logout-all"),w(),localStorage.removeItem("refresh_token")}catch(e){throw Error(E(e))}},async saveCookieConsent(e){try{await l.post("/api/auth/cookie-consent",e)}catch(e){throw Error(E(e))}},async logout(){try{g()&&await l.post("/api/auth/logout").catch(()=>{})}catch(e){}finally{w(),delete l.defaults.headers.common.Authorization}},async getMe(){try{let e=g();if(!e||"string"!=typeof e)throw Error("No token found");let t=await l.get("/api/auth/me");if(!(null==t?void 0:t.data)||"object"!=typeof t.data||"string"!=typeof t.data.email)throw Error("Invalid response from server");return{id:t.data.id,email:t.data.email,full_name:t.data.full_name,phone:t.data.phone,location:t.data.location,email_verified:t.data.email_verified||!1}}catch(e){throw console.error("getMe error:",e),e}},async verifyToken(){try{let e=g();if(!e||"string"!=typeof e)return{valid:!1,user:null};let t=await l.get("/api/auth/verify",{headers:{Authorization:"Bearer ".concat(e)}});if(!t||!t.data||"object"!=typeof t.data)return{valid:!1,user:null};return t.data}catch(e){return console.error("verifyToken error:",e),{valid:!1,user:null}}},async predictSellPrice(e,t){try{let r={...e};return t&&t.length>0&&(r.image_features=t),(await c.post("/api/sell/predict",r)).data}catch(e){throw Error(E(e))}},async analyzeImages(e){try{let t=new FormData;return e.forEach(e=>{t.append("images",e)}),(await c.post("/api/analyze-images",t)).data}catch(e){throw Error(E(e))}},async predictPriceWithImages(e,t){try{let r={features:e};return t&&t.length>0&&(r.image_features=t),(await c.post("/api/predict",r)).data}catch(e){throw Error(E(e))}},async getCarImage(e){try{let t=new URLSearchParams({make:e.make,model:e.model});return e.year&&t.append("year",e.year.toString()),e.trim&&t.append("trim",e.trim),(await c.get("/api/cars/car-image?".concat(t.toString()))).data}catch(e){return console.error("Error fetching car image:",e),{image_path:"/images/cars/default-car.jpg",found:!1,match_type:"error"}}},async predictFromUrl(e){try{if(!e||"string"!=typeof e||!e.trim())throw Error("URL is required");let t=await c.post("/api/predict/from-url",{url:e.trim()});if(t.data.success&&t.data.data){let e=t.data.data;return{extracted_data:{make:e.make,model:e.model,year:e.year,mileage:e.mileage,condition:e.condition,fuel_type:e.fuel_type,location:e.location||"Unknown",engine_size:e.engine_size||2,cylinders:e.cylinders||4},predicted_price:e.predicted_price,listing_price:e.listing_price,confidence_interval:e.price_range?{lower:e.price_range.min,upper:e.price_range.max}:void 0,price_comparison:e.listing_price&&e.predicted_price?{listing_price:e.listing_price,predicted_price:e.predicted_price,difference:e.listing_price-e.predicted_price,difference_percent:(e.listing_price-e.predicted_price)/e.predicted_price*100,is_above_market:e.listing_price>e.predicted_price,is_below_market:e.listing_price<e.predicted_price}:void 0,message:e.deal_explanation||e.message}}if(t.data.error)throw Error(t.data.error);throw Error("Invalid response format from server")}catch(e){var t,r,a,o,i,n,s,l;if("ECONNREFUSED"===e.code||(null===(t=e.message)||void 0===t?void 0:t.includes("Network Error")))throw Error("Backend not running - Please start the backend server");if((null===(r=e.response)||void 0===r?void 0:r.status)===404)throw Error("Listing no longer available - The URL may be expired or removed");if((null===(a=e.response)||void 0===a?void 0:a.status)===408||(null===(o=e.message)||void 0===o?void 0:o.includes("timeout")))throw Error("Timeout while scraping - The listing page took too long to respond");if((null===(i=e.response)||void 0===i?void 0:i.status)===429)throw Error("Rate limit exceeded - Please try again in 1 minute");if((null===(n=e.response)||void 0===n?void 0:n.status)===400){let t=(null===(l=e.response)||void 0===l?void 0:null===(s=l.data)||void 0===s?void 0:s.detail)||e.message;if(t.includes("Unsupported platform")||t.includes("Invalid URL format"))throw Error("Invalid URL format - ".concat(t));throw Error(t||"Invalid request")}throw Error(E(e))}},async savePrediction(e){try{return(await c.post("/api/feedback/predictions",{car_features:e.car_features,predicted_price:e.predicted_price,confidence_interval:e.confidence_interval,confidence_level:e.confidence_level,image_features:e.image_features})).data}catch(e){throw console.error("Error saving prediction:",e),Error(E(e))}},async submitFeedback(e){try{return(await c.post("/api/feedback/submit",e)).data}catch(e){throw console.error("Error submitting feedback:",e),Error(E(e))}},async getPredictionHistory(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{return(await c.get("/api/feedback/history",{params:{limit:e,offset:t}})).data}catch(e){throw Error(E(e))}},async getFeedbackMetrics(){try{return(await c.get("/api/feedback/metrics")).data}catch(e){throw Error(E(e))}},async adminLogin(e,t){try{let r=await l.post("/api/admin/login",{email:e,password:t}),a=r.data.access_token;return a&&(localStorage.setItem("admin_token",a),l.defaults.headers.common.Authorization="Bearer ".concat(a)),r.data}catch(e){throw Error(E(e))}},async adminLogout(){try{await l.post("/api/admin/logout").catch(()=>{})}finally{localStorage.removeItem("admin_token"),delete l.defaults.headers.common.Authorization}},async getAdminMe(){try{if(!localStorage.getItem("admin_token"))throw Error("No admin token");return(await l.get("/api/admin/me")).data}catch(e){throw Error(E(e))}},async getDashboardStats(){try{return(await l.get("/api/admin/dashboard/stats")).data}catch(e){throw Error(E(e))}},async getPredictionsOverTime(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;try{return(await l.get("/api/admin/dashboard/charts/predictions-over-time?days=".concat(e))).data}catch(e){throw Error(E(e))}},async getFeedbackRatings(){try{return(await l.get("/api/admin/dashboard/charts/feedback-ratings")).data}catch(e){throw Error(E(e))}},async getAccuracyTrend(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;try{return(await l.get("/api/admin/dashboard/charts/accuracy-trend?days=".concat(e))).data}catch(e){throw Error(E(e))}},async getFeedbackList(e){try{return(await l.get("/api/admin/feedback",{params:e})).data}catch(e){throw Error(E(e))}},async getFeedbackDetail(e){try{return(await l.get("/api/admin/feedback/".concat(e))).data}catch(e){throw Error(E(e))}},async getUsersList(e){try{return(await l.get("/api/admin/users",{params:e})).data}catch(e){throw Error(E(e))}},async getUserDetail(e){try{return(await l.get("/api/admin/users/".concat(e))).data}catch(e){throw Error(E(e))}},async deleteUser(e){try{await l.delete("/api/admin/users/".concat(e))}catch(e){throw Error(E(e))}},async getSettings(){try{return(await l.get("/api/admin/settings")).data}catch(e){throw Error(E(e))}},async triggerModelRetrain(){try{return(await l.post("/api/admin/settings/model/retrain")).data}catch(e){throw Error(E(e))}},async getDailyFeedbackReport(e){try{return(await l.get("/api/admin/reports/daily-feedback",{params:e?{date:e}:{}})).data}catch(e){throw Error(E(e))}},async getMarketplaceAnalytics(){try{return(await l.get("/api/admin/dashboard/marketplace-analytics")).data}catch(e){throw Error(E(e))}},async getAdminListings(e){try{return(await l.get("/api/admin/listings",{params:e})).data}catch(e){throw Error(E(e))}},async adminPatchListing(e,t){try{await l.patch("/api/admin/listings/".concat(e),t)}catch(e){throw Error(E(e))}},async adminDeleteListing(e){try{await l.delete("/api/admin/listings/".concat(e))}catch(e){throw Error(E(e))}},async createListing(e){try{return(await c.post("/api/marketplace/listings",e)).data}catch(e){throw Error(E(e))}},async createDraftListing(e){try{return(await c.post("/api/marketplace/listings/draft",e||{})).data}catch(e){throw Error(E(e))}},async uploadListingImages(e,t){try{let r=new FormData;return t.forEach(e=>r.append("images",e)),(await c.post("/api/marketplace/listings/".concat(e,"/images"),r)).data}catch(e){throw Error(E(e))}},async deleteListingImage(e,t){try{return(await c.delete("/api/marketplace/listings/".concat(e,"/images/").concat(t))).data}catch(e){throw Error(E(e))}},async autoDetectCar(e){try{return(await d.post("/api/marketplace/listings/".concat(e,"/auto-detect"))).data}catch(e){var t,r;if((null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(t=r.data)||void 0===t?void 0:t.status)==="error")return e.response.data;if((null==e?void 0:e.code)==="ECONNABORTED"||"string"==typeof(null==e?void 0:e.message)&&e.message.includes("timeout"))return{success:!1,status:"error",error:"Detection timed out. The AI model may be loading. Please try again in a moment.",detection:null,prefill:{}};throw Error(E(e))}},async detectCarVision(e){try{let t=await Promise.all(e.map(e=>new Promise((t,r)=>{let a=new FileReader;a.onload=()=>{let r=String(a.result),o=r.includes(",")?r.split(",")[1]:r,i=(e.type||"image/jpeg").toLowerCase(),n=/^image\/(jpeg|png|webp|gif)$/i.test(i)?i:"image/jpeg";t({data:o,media_type:n})},a.onerror=r,a.readAsDataURL(e)})));return(await d.post("/api/ai/detect-car-vision",{images:t})).data}catch(e){var t,r;if("ECONNABORTED"===e.code||(null===(r=e.message)||void 0===r?void 0:null===(t=r.includes)||void 0===t?void 0:t.call(r,"timeout")))return{make:null,model:null,confidence:0,error:"Detection timed out. Please try again."};return{make:null,model:null,confidence:0,error:E(e)}}},async updateDraftListing(e,t){try{return(await c.patch("/api/marketplace/listings/".concat(e),t)).data}catch(e){throw Error(E(e))}},async updateListingUserOverrides(e,t){try{return(await c.put("/api/marketplace/listings/".concat(e,"/user-overrides"),{selected_by_user:t,user_overrode:!0})).data}catch(e){throw Error(E(e))}},async getListing(e){if("string"==typeof e&&/^[0-9a-f-]{36}$/i.test(e))return Promise.reject(Error("UUID listings must be fetched from Supabase, not the marketplace API."));let t="number"==typeof e?e:parseInt(String(e),10);if(!Number.isInteger(t)||t<=0)return Promise.reject(Error("getListing requires a positive integer listing ID."));try{return(await c.get("/api/marketplace/listings/".concat(t))).data}catch(e){throw Error(E(e))}},async getListingAnalytics(e){try{return(await c.get("/api/marketplace/listings/".concat(e,"/analytics"))).data}catch(e){throw Error(E(e))}},async getMyListings(e){try{return(await c.get("/api/marketplace/my-listings",{params:e?{status:e}:{}})).data}catch(e){throw Error(E(e))}},async markListingAsSold(e){try{return(await c.put("/api/marketplace/listings/".concat(e,"/mark-sold"))).data}catch(e){throw Error(E(e))}},async deleteListing(e){try{return(await c.delete("/api/marketplace/listings/".concat(e))).data}catch(e){throw Error(E(e))}},async searchListings(e){try{return(await c.get("/api/marketplace/listings",{params:e})).data}catch(e){throw Error(E(e))}},async saveListing(e){try{return(await c.post("/api/marketplace/listings/".concat(e,"/save"))).data}catch(e){throw Error(E(e))}},async unsaveListing(e){try{return(await c.delete("/api/marketplace/listings/".concat(e,"/save"))).data}catch(e){throw Error(E(e))}},async publishListing(e){try{return(await c.put("/api/marketplace/listings/".concat(e,"/publish"))).data}catch(e){throw Error(E(e))}},async sendMessage(e,t,r,a){try{return(await c.post("/api/messaging/messages",{listing_id:e,recipient_id:t,content:r,image_url:a})).data}catch(e){throw Error(E(e))}},async getMessages(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;try{return(await c.get("/api/messaging/messages",{params:{listing_id:e,other_user_id:t,limit:r,offset:a}})).data}catch(e){throw Error(E(e))}},async getConversations(){try{return(await c.get("/api/messaging/conversations")).data}catch(e){throw Error(E(e))}},async getUnreadCount(){try{return(await c.get("/api/messaging/messages/unread-count")).data.unread_count||0}catch(e){return 0}},async markMessagesAsRead(e,t){try{return(await c.post("/api/messaging/messages/mark-read",{listing_id:e,other_user_id:t})).data}catch(e){return{success:!1}}},async blockUser(e){try{return(await c.post("/api/messaging/conversations/".concat(e,"/block"))).data}catch(e){throw Error(E(e))}},async unblockUser(e){try{return(await c.post("/api/messaging/conversations/".concat(e,"/unblock"))).data}catch(e){throw Error(E(e))}},async reportMessage(e,t){try{return(await c.post("/api/messaging/messages/".concat(e,"/report"),null,{params:{reason:t}})).data}catch(e){throw Error(E(e))}},async deleteConversation(e){try{return(await c.delete("/api/messaging/conversations/".concat(e))).data}catch(e){throw Error(E(e))}},async starConversation(e,t){try{return(await c.post("/api/messaging/conversations/".concat(e,"/star"),null,{params:{starred:t}})).data}catch(e){throw Error(E(e))}},async setTypingIndicator(e,t){try{return(await c.post("/api/messaging/typing-indicator",{conversation_id:e,is_typing:t})).data}catch(e){return{success:!1}}},async getTypingIndicator(e){try{return(await c.get("/api/messaging/typing-indicator/".concat(e))).data.is_typing||!1}catch(e){return!1}},async toggleFavorite(e){try{return(await c.post("/api/favorites/toggle",null,{params:{listing_id:String(e)}})).data}catch(e){if(a.Z.isAxiosError(e))throw e;throw Error(E(e))}},async checkFavorite(e){try{return(await c.get("/api/favorites/check/".concat(String(e)))).data}catch(e){return{is_favorite:!1}}},async getFavorites(e){try{return(await c.get("/api/favorites/list",{params:e})).data}catch(e){var t,r;throw console.error("[apiClient.getFavorites] Error:",e),console.error("[apiClient.getFavorites] Error status:",null===(t=e.response)||void 0===t?void 0:t.status),console.error("[apiClient.getFavorites] Error data:",null===(r=e.response)||void 0===r?void 0:r.data),Error(E(e))}},async getFavoritesCount(e){try{return(await c.get("/api/favorites/count/".concat(String(e)))).data.count||0}catch(e){return 0}},async saveSearch(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"instant";try{return(await c.post("/api/favorites/searches",{name:e,filters:t,email_alerts:r,frequency:a})).data}catch(e){throw Error(E(e))}},async getSavedSearches(){try{return(await c.get("/api/favorites/searches")).data}catch(e){throw Error(E(e))}},async updateSavedSearch(e,t){try{return(await c.put("/api/favorites/searches/".concat(e),t)).data}catch(e){throw Error(E(e))}},async deleteSavedSearch(e){try{return(await c.delete("/api/favorites/searches/".concat(e))).data}catch(e){throw Error(E(e))}},async getPriceHistory(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30;try{return(await c.get("/api/favorites/price-history/".concat(e),{params:{days:t}})).data}catch(e){throw Error(E(e))}},async getNotificationSettings(){try{return(await c.get("/api/favorites/notifications/settings")).data}catch(e){throw e}},async updateNotificationSettings(e){try{return(await c.put("/api/favorites/notifications/settings",e)).data}catch(e){throw e}},async getServices(e){try{return(await c.get("/api/services",{params:e})).data}catch(e){var t,r,a,o;throw console.error("❌ [API] getServices error:",e),console.error("❌ [API] Error details:",{message:e.message,response:null===(t=e.response)||void 0===t?void 0:t.data,status:null===(r=e.response)||void 0===r?void 0:r.status,url:null===(a=e.config)||void 0===a?void 0:a.url,baseURL:null===(o=e.config)||void 0===o?void 0:o.baseURL}),Error(E(e))}},async getService(e){try{return(await c.get("/api/services/".concat(e))).data}catch(e){throw Error(E(e))}},async getServicesByLocation(e){try{return(await c.get("/api/services/location/".concat(e))).data}catch(e){throw Error(E(e))}},async getFeaturedServices(){try{return(await c.get("/api/services/featured")).data}catch(e){throw Error(E(e))}},async trackServiceView(e){try{return(await c.post("/api/services/".concat(e,"/view"))).data}catch(e){throw Error(E(e))}},async trackServiceClick(e){try{return(await c.post("/api/services/".concat(e,"/click"))).data}catch(e){throw Error(E(e))}},async getLocations(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];try{return(await c.get("/api/locations",{params:{active_only:e}})).data}catch(e){var t,r;throw console.error("❌ [API] getLocations error:",e),console.error("❌ [API] Error details:",{message:e.message,response:null===(t=e.response)||void 0===t?void 0:t.data,status:null===(r=e.response)||void 0===r?void 0:r.status}),Error(E(e))}},async adminGetServices(e){try{return(await c.get("/api/admin/services",{params:e})).data}catch(e){throw Error(E(e))}},async adminGetService(e){try{return(await c.get("/api/admin/services/".concat(e))).data}catch(e){throw Error(E(e))}},async adminCreateService(e){try{return(await c.post("/api/admin/services",e)).data}catch(e){throw Error(E(e))}},async adminUpdateService(e,t){try{return(await c.put("/api/admin/services/".concat(e),t)).data}catch(e){throw Error(E(e))}},async adminDeleteService(e){try{return(await c.delete("/api/admin/services/".concat(e))).data}catch(e){throw Error(E(e))}},async adminToggleServiceStatus(e,t){try{return(await c.patch("/api/admin/services/".concat(e,"/status"),null,{params:{status:t}})).data}catch(e){throw Error(E(e))}},async adminBulkDeleteServices(e){try{return(await c.post("/api/admin/services/bulk-delete",e)).data}catch(e){throw Error(E(e))}},async adminReorderServices(e){try{return(await c.post("/api/admin/services/reorder",e)).data}catch(e){throw Error(E(e))}},async adminGetLocations(){try{return(await c.get("/api/admin/locations")).data}catch(e){throw Error(E(e))}},async adminCreateLocation(e){try{return(await c.post("/api/admin/locations",e)).data}catch(e){throw Error(E(e))}},async adminUpdateLocation(e,t){try{return(await c.put("/api/admin/locations/".concat(e),t)).data}catch(e){throw Error(E(e))}},async adminDeleteLocation(e){try{return(await c.delete("/api/admin/locations/".concat(e))).data}catch(e){throw Error(E(e))}},async getServiceProviders(e,t){try{return(await c.get("/api/services/".concat(e,"/providers"),{params:t})).data}catch(e){throw Error(E(e))}},async getProvider(e){try{return(await c.get("/api/providers/".concat(e))).data}catch(e){throw Error(E(e))}},async adminGetProviders(e){try{return(await l.get("/api/admin/providers",{params:e})).data}catch(e){throw Error(E(e))}},async adminCreateProvider(e){try{return(await l.post("/api/admin/providers",e)).data}catch(e){throw Error(E(e))}},async adminUpdateProvider(e,t){try{return(await l.put("/api/admin/providers/".concat(e),t)).data}catch(e){throw Error(E(e))}},async adminDeleteProvider(e){try{return(await l.delete("/api/admin/providers/".concat(e))).data}catch(e){throw Error(E(e))}},async get(e,t){try{return await c.get(e,t)}catch(e){throw e}},async post(e,t,r){try{return await c.post(e,t,r)}catch(e){throw e}},async put(e,t,r){try{return await c.put(e,t,r)}catch(e){throw e}},async delete(e,t){try{return await c.delete(e,t)}catch(e){throw e}}}}}]);