name: Daily Dataset Update

on:
  schedule:
    # Run daily at 2:00 AM UTC (adjust timezone as needed)
    # For your timezone, adjust: UTC+3 = 2 AM local = 11 PM previous day UTC
    - cron: '0 23 * * *'  # 11 PM UTC = 2 AM Iraq time (UTC+3)
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-dataset:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours timeout (for 500 listings)
    permissions:
      contents: write  # Allow writing to repository
      actions: read    # Allow reading actions
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Fetch full history for git operations
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: Create email config from secrets
      env:
        EMAIL_ENABLED: ${{ secrets.EMAIL_ENABLED }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
      run: |
        cat > email_config.json << EOF
        {
          "enabled": "$EMAIL_ENABLED",
          "smtp_server": "$SMTP_SERVER",
          "smtp_port": $SMTP_PORT,
          "sender_email": "$SENDER_EMAIL",
          "sender_password": "$SENDER_PASSWORD",
          "recipients": ["$RECIPIENT_EMAIL"],
          "alert_thresholds": {
            "price_change_pct": 30,
            "market_deviation_pct": 25,
            "confidence_threshold": 0.7
          },
          "send_daily_summary": true,
          "summary_time": "08:00",
          "use_tls": true
        }
        EOF
    
    - name: Run daily update pipeline
      env:
        PYTHONUNBUFFERED: 1
      run: |
        # Ensure Web Scraping Tool directory exists
        ls -la "Web Scraping Tool/" || echo "Web Scraping Tool directory check"
        python daily_update_pipeline.py --mode once --max-listings 500 || true
      continue-on-error: true  # Continue even if scraping fails
      id: run-pipeline
    
    - name: Send workflow status email
      if: always()
      env:
        EMAIL_ENABLED: ${{ secrets.EMAIL_ENABLED }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
      run: |
        python << 'EOF'
        import smtplib
        import os
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        from datetime import datetime
        
        if os.getenv('EMAIL_ENABLED', 'false').lower() != 'true':
            print("Email disabled, skipping notification")
            exit(0)
        
        try:
            # Create message
            msg = MIMEMultipart()
            msg['From'] = os.getenv('SENDER_EMAIL')
            msg['To'] = os.getenv('RECIPIENT_EMAIL')
            
            workflow_status = "${{ job.status }}"
            run_number = "${{ github.run_number }}"
            run_url = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            if workflow_status == "success":
                subject = "✅ GitHub Actions: Daily Dataset Update Completed"
                body = f"""
                <html>
                <body>
                    <h2>✅ Daily Dataset Update Completed</h2>
                    <p><strong>Workflow Run:</strong> #{run_number}</p>
                    <p><strong>Status:</strong> Success</p>
                    <p><strong>Time:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}</p>
                    <p><strong>View Details:</strong> <a href="{run_url}">Click here</a></p>
                    <p>The daily update workflow has completed successfully.</p>
                </body>
                </html>
                """
            else:
                subject = "❌ GitHub Actions: Daily Dataset Update Failed"
                body = f"""
                <html>
                <body>
                    <h2>❌ Daily Dataset Update Failed</h2>
                    <p><strong>Workflow Run:</strong> #{run_number}</p>
                    <p><strong>Status:</strong> Failed</p>
                    <p><strong>Time:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}</p>
                    <p><strong>View Details:</strong> <a href="{run_url}">Click here</a></p>
                    <p>Please check the workflow logs for more information.</p>
                </body>
                </html>
                """
            
            msg['Subject'] = subject
            msg.attach(MIMEText(body, 'html'))
            
            # Send email
            server = smtplib.SMTP(os.getenv('SMTP_SERVER'), int(os.getenv('SMTP_PORT')))
            server.starttls()
            server.login(os.getenv('SENDER_EMAIL'), os.getenv('SENDER_PASSWORD').replace(' ', ''))
            server.send_message(msg)
            server.quit()
            
            print(f"✅ Workflow status email sent successfully")
        except Exception as e:
            print(f"❌ Failed to send workflow status email: {e}")
            exit(0)  # Don't fail the workflow if email fails
        EOF
      continue-on-error: true
    
    - name: Check for changes
      id: check-changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        git add cleaned_car_data.csv daily_update.log config.py || true
        git diff --cached --quiet || git commit -m "Auto-update: Daily dataset update - $(date +'%Y-%m-%d %H:%M:%S UTC')"
        git push
    
    - name: Upload update log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-update-log
        path: daily_update.log
        retention-days: 7
    
    - name: Send workflow completion notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Workflow completed successfully"
          echo "Check the daily_update.log artifact for details"
        else
          echo "❌ Workflow failed - check logs for details"
        fi

